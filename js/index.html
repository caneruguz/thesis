<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>Research Scripts </title>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">



        <style>

        .commands {
            background-color: #eee;
            height: 600px;
        }
        .console {
            background-color: #57576F;
            height: 600px;
            padding: 10px;
            font-family: monospace;
            overflow: scroll;
        }
        .output {
            height: 150px;
            overflow: scroll;
            background: #f8f8f8;
            color: #008000;
        }
        .console .log-message.default {
            color: #eee;
        }
        .console .log-message.success {
            color: #B9F7CF;
        }
        .console .log-message.danger {
            color: #FDA0A0;
        }
        .console .log-message.warning {
            color: #F7FDA0;
        }

        </style>
    </head>
    <body>

    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-3 commands">
                <h3> Commands</h3>
                <p>Use commands available below to restructure data.</p>
                <button id="btnLoad" class="btn btn-sm btn-default btn-block">Load data</button>
                <button id="btnReset" class="btn btn-sm btn-default btn-block">Reset data</button>
                <hr />
                <button id="btnCor" class="btn btn-sm btn-default btn-block">Build Correlation Data</button>
                <button id="btnPage" class="btn btn-sm btn-default btn-block">Build Page Data</button>


                <button id="saveCSV" class="btn btn-sm btn-default btn-block">Save CSV</button>

            </div>
            <div class="col-xs-9 console">
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 output" style="white-space: pre;">
                CSV output will appear here....
            </div>
        </div>
    </div>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<script src="libs/FileSaver.min.js"></script>

    <script type="text/javascript">
        var full_data;
        var full_click_track;
        var short_outcome;
        var users = {};
        var newUserData = [];
        var lineNumber = 0;
        var page_data = [];
        var mr_data = [];

        function log (text, type) {
            lineNumber++;
            $('.console').append('<div class="log-message ' + type + '" data-line="' + lineNumber + '">' + lineNumber + ': ' + text + '<div>');
        }
        function reset (){
            full_data = [];
            full_click_track = [];
            short_outcome = [];

            users = [];
            log('Variables have been reset to empty', 'default');
        }

        function getFullData () {
            log('Getting data full_data.json', 'default');
            $.ajax({
                method : 'GET',
                url : 'full_data.json'
            }).done(function(result){
                console.log(result);
                full_data = result;
                log('Received data full_data.json.' + result.length + ' rows.', 'success');
            }).fail(function(){
                log('Failed to receive full_data.json', 'danger');
            })
        }

        function getLogs () {
            log('Getting data full_click_track.json', 'default');
            $.ajax({
                method : 'GET',
                url : 'full_click_track.json'
            }).done(function(result){
                console.log(result);
                full_click_track = result;
                log('Received data full_click_track.json.' + result.length + ' rows.', 'success');
            }).fail(function(){
                log('Failed to receive full_click_track.json', 'danger');
            })
        }

        function refactorLogstoStudents () {
            var row;
            var i;
            var user;
            var total;
            var uniqueTotal;
            for(i= 0; i < full_click_track.length; i++){
                row = full_click_track[i];
                user = users[row.student];
                if (!user){
                    user = {
                        id : row.student,
                        totalLow : 0,
                        totalHigh: 0,
                        totalUniqueLow: 0,
                        totalUniqueHigh: 0,
                        totalNoteLength : 0,
                        relevancyRatio : 0.0, // percentage of high
                        uniqueRelevancyRatio: 0.0,
                        temp : {
                            usedURLs : []
                        }
                    }
                    users[row.student] = user;
                }
                if(row.Relevancy === 'Low'){
                    user.totalLow++
                }
                if(row.Relevancy === 'High'){
                    user.totalHigh++
                }
                if(user.temp.usedURLs.indexOf(row.url) === -1 ){
                    if(user.NOTE !== 'NULL'){
                        user.totalNoteLength = user.totalNoteLength + row.NOTE.length;
                    }
                    if(row.Relevancy === 'Low'){
                        user.totalUniqueLow++
                    }
                    if(row.Relevancy === 'High'){
                        user.totalUniqueHigh++
                    }
                    user.temp.usedURLs.push(row.url);
                }
                total = user.totalHigh + user.totalLow;
                user.relevancyRatio = Math.round((user.totalHigh / total) * 100) / 100;

                uniqueTotal = user.totalUniqueHigh + user.totalUniqueLow;
                user.uniqueRelevancyRatio = Math.round((user.totalUniqueHigh / uniqueTotal) * 100) / 100 ;

            }
            buildUserData();
        }

        function buildUserData (){
            var i;
            var oldRow;
            var newRow;
            var user;
            for (i = 0; i < full_data.length; i++){
                oldRow = full_data[i];
                newRow = {};
                if(users[oldRow.StudentID]){
                    user = users[oldRow.StudentID];
                    newRow.student = oldRow.StudentID;
                    newRow.totalLow = user.totalLow;
                    newRow.totalHigh= user.totalHigh;
                    newRow.totalUniqueLow= user.totalUniqueLow;
                    newRow.totalUniqueHigh= user.totalUniqueHigh;
                    newRow.totalNoteLength= user.totalNoteLength;
                    newRow.relevancyRatio = user.relevancyRatio;
                    newRow.uniqueRelevancyRatio = user.uniqueRelevancyRatio;
                    newRow.Step1Q1A = oldRow.Step1Q1A < 98 ? oldRow.Step1Q1A : 'NA';
                    newRow.Step1Q1B = oldRow.Step1Q1B < 98 ? oldRow.Step1Q1B : 'NA';
                    newRow.Step1Q1C = oldRow.Step1Q1C < 98 ? oldRow.Step1Q1C : 'NA';
                    if(newRow.Step1Q1C === 'NA' && newRow.Step1Q1B  === 'NA' && newRow.Step1Q1A  === 'NA' ){
                        newRow.Step1QTotal = 'NA';
                    } else {
                        var a = newRow.Step1Q1A === 'NA' ? 0 : newRow.Step1Q1A;
                        var b = newRow.Step1Q1B === 'NA' ? 0 : newRow.Step1Q1B;
                        var c = newRow.Step1Q1C === 'NA' ? 0 : newRow.Step1Q1C;
                        newRow.Step1QTotal = a + b + c;

                    }
                    newRow.TotalScore = oldRow.TotalScore;
                }
                newUserData.push(newRow);
            }
            console.log('New: ', newUserData);
            log('User data built', 'default');

            outputCSV(newUserData);
        }

        function buildPageData () {
            var urlList = [];
            var urlListCounts = [];
            var tempPageData = {};
            var i, j, k;
            var o, m, n;
            for (i = 0; i < full_click_track.length; i++) {
                o = full_click_track[i];
                var student = o.student;
                var url = o.url;
                // If student object doesn't exit, create it
                if(!tempPageData[student]){
                    tempPageData[student] = {
                        student : student
                    };
                }
                // Add web page count to the student object
                var studentData = tempPageData[student];
                if(!studentData[url]){
                    studentData[url] = 1;
                } else {
                    studentData[url]++;
                }

                // Add to unique url list to build 0 columns later
                var urlListIndex = urlList.indexOf(url);
                if( urlListIndex === -1 ){
                    var newIndex = urlList.push(url);
                    urlListCounts[newIndex-1] = 1;
                } else {
                    urlListCounts[urlListIndex]++;
                }
            }
            // Add score total to object
            for(k = 0; k < full_data.length; k++){
                n = full_data[k];
                if(tempPageData[n.StudentID]){
                    var Step1Q1A = n.Step1Q1A < 98 ? n.Step1Q1A : 0;
                    var Step1Q1B = n.Step1Q1B < 98 ? n.Step1Q1B : 0;
                    var Step1Q1C = n.Step1Q1C < 98 ? n.Step1Q1C : 0;
                    var totalScores = Step1Q1A + Step1Q1B + Step1Q1C;
                    tempPageData[n.StudentID].score = totalScores;
                }
            }

            Object.keys(tempPageData).forEach(function(key, index, array) {
                var value = tempPageData[key];
                for(j = 0; j < urlList.length; j++){
                    m = urlList[j];
                    if(!value[m]){
                        value[m] = 0;
                    }
                }
                page_data.push(value);
            })

            console.log(urlListCounts);
            outputCSV(page_data);
        }

        function outputCSV (data) {
            var i;
            var row;
            var text = '';
            var header = '';
            var headerDone = false;
            var comma = '';
            for (i = 0; i < data.length; i++) {
                row = data[i];
                if (!row.student){
                    continue;
                }
                Object.keys(row).forEach(function(key, index, array) {
                    var value = row[key];
                    if(index === 0){
                        comma = '';
                    } else {
                        comma = ',';
                    }
                    if(!headerDone){
                        header += comma + key;
                    }
                    text += comma + value;
                });
                headerDone = true;
                text += ('\n');
            }
            $('.output').html(header + '\n' + text);
            log('CSV output completed for ' + data.length + ' rows.', 'default');
        }


        $(document).ready(function(){
            log('Ready to go. ', 'default');
            $('#btnLoad').click(function(){
                getFullData();
                getLogs();
            });
            $('#btnReset').click(function(){
                reset();
            });
            $('#btnCor').click(function(){
                refactorLogstoStudents();
            });
            $('#btnPage').click(function(){
                buildPageData();
            });
            $('#saveCSV').click(function(){
                var blob = new Blob([$('.output').text()], {type: "text/plain;charset=utf-8"});
                saveAs(blob, "output/temp.csv");
            })
        });
    </script>


    </body>
</html>